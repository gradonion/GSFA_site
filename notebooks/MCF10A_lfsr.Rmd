---
title: "Local False Sign Rate Estimate of KO Effect on Genes"
author: "Yifan Zhou (zhouyf@uchicago.edu)"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_float: true
---

```{r setup, include=FALSE}
requireNamespace("pander", quietly = TRUE)
library(data.table)
library(Matrix)
library(tidyverse)
library(ggplot2)
theme_set(theme_bw() + theme(plot.title = element_text(size = 14, hjust = 0.5),
                             axis.title = element_text(size = 14),
                             axis.text = element_text(size = 12),
                             legend.title = element_text(size = 13),
                             legend.text = element_text(size = 12),
                             panel.grid.minor = element_blank())
)
library(gridExtra)
library(ComplexHeatmap)
library(kableExtra)

# set default chunk output
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      comment = NA,
                      tidy = FALSE,
                      fig.width = 8,
                      fig.height = 6,
                      fig.align = "center",
                      results = "asis")

# formatting of pander tables
pander::panderOptions('knitr.auto.asis', FALSE)
pander::panderOptions("table.split.table", Inf)
wkdir <- "/project2/xinhe/yifan/Factor_analysis/GSE108699_MCF10A/"
```

```{r}
source("/project2/xinhe/yifan/Factor_analysis/reports/R/analytics_functions.R")
print_signif_tb <- function(signif_num, caption_text){
  if (length(signif_num) < 30){
    signif_num <- c(signif_num, rep(NA, 30 - length(signif_num)))
  }
  signif_num <- t(data.frame(KO = names(signif_num),
                             Num_genes = signif_num,
                             row.names = NULL))
  print(knitr::kable(rbind(signif_num[, 1:10], signif_num[, 11:20], signif_num[, 21:30]),
               caption = caption_text) %>%
    kable_styling() %>% scroll_box(width = '100%'))
}
print_lfsr_signif_tb <- function(lfsr_mat, lfsr_cutoff, caption_text){
  signif_num <- colSums(lfsr_mat < lfsr_cutoff)
  print_signif_tb(signif_num, caption_text)
}

dge_cutoff <- 0.05
lfsr_cutoff_1 <- 0.05
lfsr_cutoff_2 <- 0.01
```

# Differential Gene Expression

We can compare the gene expression profiles of cells under each KO (gRNA) condition with those of cells without this gRNA using a simple Wilcoxon rank sum test in Seurat.

The number of genes that passed an FDR threshold of 0.05 under each KO condition is:

```{r wilcox_DE}
DE_list <- readRDS(paste0(wkdir, "preprocess_output/DE_results.all_markers.seurat_wilcox.rds"))
DE_signif_counts <- sapply(DE_list, function(x){filter(x, p_val_adj < dge_cutoff) %>% nrow()})
print_signif_tb(DE_signif_counts,
                caption_text = paste0("Wilcoxon DGE, FDR cutoff: ", dge_cutoff))
```

# LFSR Estimation from GSFA

In terms of our GSFA method, we can also determine if a KO condition has an significant effect on gene expression in the following way:

For a given GSFA inference result, we estimated the local false sign rate (lfsr) of a certain knock-out effect on each gene based on the posteriors of $\beta$ and $W$.

For gene $j$ and KO condition $m$,
$$lfsr_{mj} = \text{min} \Big\{\text{Pr}(\sum_{k=1}^K \beta_{mk}W_{jk} \geq 0 \text{ | Data}), \text{Pr}(\sum_{k=1}^K \beta_{mk}W_{jk} \leq 0 \text{ | Data}) \Big\}$$
Under each KO condition, the number of genes that pass a certain lfsr cutoff would be compared to that from a the Wilcoxon DGE analysis mentioned above.

We focus on GSFA results on genes filtered by the criterion of detection rate > 10% (8046 genes kept), since we observed in our permutation analysis that the factors obtained in this way are the most well calibrated.

## GSFA Detection > 10% (NTC condition regressed out)

```{r eval=FALSE, include=FALSE}
no_NTC.lfsr_mat <- readRDS(paste0(wkdir, "gsfa_output_detect_01/sparse_beta_singleton/",
                           "lfsr/no_NTC.gibbs_k20_svd.lfsr_mat.1k-2k.rds"))
print_lfsr_signif_tb(no_NTC.lfsr_mat, lfsr_cutoff_1,
                     paste0("GSFA Detection > 10% Genes, lfsr cutoff: ", lfsr_cutoff_1))
print_lfsr_signif_tb(no_NTC.lfsr_mat, lfsr_cutoff_2,
                     paste0("GSFA Detection > 10% Genes, lfsr cutoff: ", lfsr_cutoff_2))
```

## Overlap between NTC-included and NTC-regressed-out results

## Comparison between NTC-regressed-out and Wilcoxon DGE results

```{r load gene names, eval=FALSE, include=FALSE}
## Normalized expression:
scaled.gene_exp <- readRDS(paste0(wkdir, 'data/cropseq_dox.scaled_detect_01.corrected_lib_NTC.rds'))
detect_01_genes <- rownames(scaled.gene_exp)
```
